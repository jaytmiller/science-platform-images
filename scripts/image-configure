#! /usr/bin/env python

import argparse
import re
import shutil


def create_setup_env_file(args) -> None:

    shutil.copy("setup-env.template", "setup-env")

    use_frozen = {"floating": "0", "frozen": "1"}.get(args.use_frozen, args.use_frozen)

    with open("setup-env", "r") as file:
        content = file.read()

        content = re.sub(
            r"DEPLOYMENT_NAME=.+",
            f"DEPLOYMENT_NAME={args.deployment}",
            content,
        )

        content = re.sub(
            r"PLATFORM=.+",
            f"PLATFORM={args.platform}",
            content,
        )

        content = re.sub(
            r"ENVIRONMENT=.+",
            f"ENVIRONMENT={args.environment}",
            content,
        )

        content = re.sub(r"USE_FROZEN=[\d]", f"USE_FROZEN={use_frozen}", content)

        content = re.sub(r"FREEZE=[\d]", f"FREEZE={args.freeze}", content)

        content = re.sub(r"REPACK=[\d]", f"REPACK={args.repack}", content)

        content = re.sub(r"CAL_VERSION=.+", f"CAL_VERSION={args.cal_version}", content)

        content = re.sub(r"OWNER=.+", f"OWNER={args.owner}", content)
        if args.owner == "spacetelescope":
            content = re.sub(r"REGISTRY=.+", 'REGISTRY=""', content)
        else:
            content = re.sub(r"REGISTRY=.+", f'REGISTRY="{args.owner}/"', content)

        content = re.sub(r"BASE_NOTEBOOK=.+", f"BASE_NOTEBOOK={args.base_notebook}", content)

    if args.no_docker_caching:
        content += "\nexport CACHE_DIRS=''\n"

    with open("setup-env", "w+") as file:
        file.write(content)
    print(content)


def main():
    parser = argparse.ArgumentParser(
        description="Create setup-env file to define image build properties."
    )
    parser.add_argument(
        "deployment",
        choices=["tike", "roman", "jwebbinar", "wrangler"],
        help="The deployment name defining image contents.",
    )
    parser.add_argument(
        "--environment",
        choices=["sandbox", "dev", "test", "prod", "int"],
        default="sandbox",
        help="The deployment name defining image contents.",
    )
    parser.add_argument(
        "--platform",
        choices=["linux/amd64", "linux/aarch64"],
        default="linux/amd64",
        help="The OS/instruction-set for building and running images.",
    )
    parser.add_argument(
        "--use-frozen",
        type=str,
        choices=["0", "1", "floating", "frozen"],
        default="floating",
        help="Use floating (default: 0).",
    )
    parser.add_argument(
        "--freeze",
        type=int,
        default=0,
        choices=[0, 1],
        help="Don't freeze requirements, let them float to highest versions possible (default: 0).",
    )
    parser.add_argument(
        "--repack",
        type=int,
        default=0,
        choices=[0, 1],
        help="Repack the image to reduce size.",
    )
    parser.add_argument(
        "--no-docker-caching",
        action="store_true",
        help="Don't use the per-RUN Docker daemon build caches defined by CACHE_DIRS.  Set CACHE_DIRS to ''.",
    )
    parser.add_argument(
        "--cal-version",
        default="none",
        help="Calibration s/w version when applicable (default: none).",
    )
    parser.add_argument(
        "--owner",
        type=str,
        default="spacetelescope",
        choices=["spacetelescope", "quay.io/jupyter"],
        help="Repo used to build or pull scipy-notebook image,  spacetelescope(build) or quay.io/jupyter(pull)",
    )
    parser.add_argument(
        "--base-notebook",
        type=str,
        default="scipy-notebook",
        choices=["scipy-notebook", "minimal-notebook", "base-notebook", "pytorch-notebook", "tensorflow-notebook",
                 "julia-notebook", "pyspark-notebook", "r-notebook", "all-spark-notebook"],
        help="Docker-stacks notebook type to build or pull.  scipy-notebook(tike,roman,jwebbinar), minimal-notebook(wrangler)"
    )
    args = parser.parse_args()

    create_setup_env_file(args)

if __name__ == "__main__":
    main()
